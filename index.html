<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>最強777</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <style>
    :root{
      --bg:#0b1220; --card:#121a2c; --line:rgba(34,48,79,.7);
      --text:#e7eefc; --muted:#93a4c7;
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --btn:#203055;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:linear-gradient(180deg,#0b1220 0%, #0a1020 55%, #070b14 100%);
    }
    header{padding:18px 16px 10px}
    h1{margin:0 0 6px; font-size:20px; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:12px; line-height:1.35}
    .wrap{padding:0 16px 18px; max-width:760px; margin:0 auto}
    .card{
      background:rgba(18,26,44,.92);
      border:1px solid rgba(34,48,79,.9);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      padding:14px; margin:10px 0;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1; min-width:240px}
    label{display:block; font-size:12px; color:var(--muted); margin:8px 0 6px}
    .hint{font-size:11px; color:var(--muted); margin-top:6px}
    .sep{height:1px; background:var(--line); margin:12px 0}
    .btnrow{display:flex; gap:10px; margin-top:10px}
    button{
      flex:1; padding:12px 12px; border-radius:14px;
      border:1px solid rgba(34,48,79,.9);
      background:linear-gradient(180deg, rgba(32,48,85,.9), rgba(20,32,60,.9));
      color:var(--text); font-weight:700;
    }
    button:active{transform:translateY(1px)}
    .pillrow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      background:rgba(15,23,42,.55);
      border:1px solid rgba(34,48,79,.9);
      color:var(--text); font-size:12px;
    }
    .dot{width:10px; height:10px; border-radius:50%}
    .b-good{background:var(--good)}
    .b-warn{background:var(--warn)}
    .b-bad{background:var(--bad)}

    /* 6個/5個の入力ボックス */
    .grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:8px;
    }
    .grid.mini{grid-template-columns: repeat(5, 1fr)}
    .n{
      width:100%;
      padding:12px 0;
      text-align:center;
      font-size:18px;
      border-radius:12px;
      border:1px solid rgba(34,48,79,.9);
      background:rgba(15,23,42,.55);
      color:var(--text);
      outline:none;
    }
    .n::placeholder{color:rgba(147,164,199,.55)}
    .n:focus{border-color:rgba(147,164,199,.8)}
    .n.invalid{border-color:rgba(239,68,68,.9)}

    .bigout{
      font-size:18px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(34,48,79,.9);
      background:rgba(15,23,42,.55);
      margin-top:8px;
    }
    .mono{font-variant-numeric:tabular-nums}
    .small{font-size:11px; color:var(--muted)}
    .list .item{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(34,48,79,.9);
      background:rgba(15,23,42,.55);
      display:flex; justify-content:space-between; gap:12px;
      margin-top:8px;
    }
    footer{padding:10px 16px 18px; color:var(--muted); font-size:11px}
  </style>
</head>

<body>
  <header class="wrap">
    <h1>最強777</h1>
    <div class="sub">入力最小 → 母集団7を自動算出 → 7通り（7C6）を即出力</div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="row" style="align-items:flex-start;">
        <div class="col">
          <label>直近ロト6（必須 / 6個）</label>
          <div class="grid" id="gridLoto6"></div>
          <div class="hint">※ 1個ずつ入れるだけ（区切り不要）／1〜43／重複はエラー</div>
        </div>

        <div class="col">
          <label>直近ミニロト（任意 / 5個）</label>
          <div class="grid mini" id="gridMini"></div>
          <div class="hint">※ 入れると「連動ボーナス」が乗る（未入力でもOK）</div>
        </div>
      </div>

      <div class="btnrow">
        <button id="btnCalc">計算する</button>
        <button id="btnReset">クリア</button>
      </div>

      <div class="pillrow">
        <div class="pill" id="statusPill"><span class="dot b-warn"></span><span id="statusText">準備OK → 入力して計算</span></div>
        <div class="pill" id="judgePill"><span class="dot b-warn"></span><span id="judgeText">判定：未計算</span></div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="col">
          <label>最強777（母集団7）</label>
          <div class="bigout mono" id="coreOut">—</div>
          <div class="small">（ここに7個が出る）</div>
        </div>
        <div class="col">
          <label>7通り（7C6）</label>
          <div class="list" id="combos"></div>
          <div class="small">（条件に合うものだけ表示）</div>
        </div>
      </div>
    </div>
  </main>

  <footer class="wrap">
    ※ フィルター/スコアは常時ON（操作不要）／ 固定・削除は自動決定（入力不要）
  </footer>

<script>
  const $ = (id)=>document.getElementById(id);

  // --- UI生成（6個/5個の小入力） ---
  function makeBoxes(parentId, count, placeholderStart=1){
    const root = $(parentId);
    root.innerHTML = "";
    for(let i=0;i<count;i++){
      const inp = document.createElement("input");
      inp.className = "n mono";
      inp.type = "tel";                 // 数字キーボード優先
      inp.inputMode = "numeric";
      inp.placeholder = String(placeholderStart+i);
      inp.autocomplete = "off";
      inp.maxLength = 2;                // 1〜43/31想定
      inp.addEventListener("input", ()=>{
        inp.classList.remove("invalid");
        // 2桁入ったら次へ（体感かなりラク）
        if(inp.value.length >= 2){
          const next = root.querySelectorAll("input")[i+1];
          if(next) next.focus();
        }
      });
      root.appendChild(inp);
    }
  }
  makeBoxes("gridLoto6", 6, 3);
  makeBoxes("gridMini", 5, 1);

  // --- 状態表示 ---
  function setPill(pillId, textId, kind, text){
    const pill = $(pillId);
    const dot = pill.querySelector(".dot");
    dot.className = "dot " + (kind==="good" ? "b-good" : kind==="bad" ? "b-bad" : "b-warn");
    $(textId).textContent = text;
  }
  function setStatus(t){ setPill("statusPill","statusText","warn",t); }
  function setJudge(kind, t){ setPill("judgePill","judgeText",kind,t); }

  // --- 入力取得 & バリデーション ---
  function readNumsFromBoxes(parentId, min, max, requiredCount){
    const inputs = $(parentId).querySelectorAll("input");
    const nums = [];
    let ok = true;

    inputs.forEach(inp=>{
      const v = inp.value.trim();
      if(v==="") return;
      const n = Number(v);
      if(!Number.isInteger(n) || n<min || n>max){
        inp.classList.add("invalid"); ok=false; return;
      }
      nums.push(n);
    });

    // 必須数チェック（空もある場合にエラー）
    if(requiredCount != null){
      // 全部埋めて欲しい：空があるならエラー
      let filled = 0;
      inputs.forEach(inp=>{ if(inp.value.trim()!=="") filled++; });
      if(filled !== requiredCount){
        inputs.forEach(inp=>{ if(inp.value.trim()==="") inp.classList.add("invalid"); });
        ok=false;
      }
    }

    // 重複チェック
    const set = new Set(nums);
    if(set.size !== nums.length){
      // 重複っぽい入力を赤く
      const seen = new Set();
      inputs.forEach(inp=>{
        const v = inp.value.trim();
        if(v==="") return;
        if(seen.has(v)) inp.classList.add("invalid");
        seen.add(v);
      });
      ok=false;
    }

    return { ok, nums, inputs };
  }

  // --- スコア（強め）: まずは “いま入ってる情報だけ” で動く版 ---
  // ここは後で「直近20回/50回」データを入れると本気になる。
  function scoreNumber(n, lastLoto6, lastMini){
    let s = 0;

    // ① 直近ロト6に出た数字：引っ張り要素（強め）
    if(lastLoto6.includes(n)) s += 6;

    // ② 直近ミニロトに出た数字：連動ボーナス（強め）
    if(lastMini.includes(n)) s += 4;

    // ③ 中央コア寄り（18〜27）を少し評価
    if(n>=18 && n<=27) s += 2;

    // ④ 端（1〜8 / 36〜43）を少し抑制（強め）
    if(n<=8 || n>=36) s -= 1;

    return s;
  }

  // --- 母集団7の作り方（入力最小版） ---
  // ルール：候補プール =（直近ロト6）＋（直近ミニロト）を合体→スコア順
  // 固定(最大2) = 上位から自動
  // 母集団7 = 固定を含めつつ上位を埋める（不足分は周辺±1で補完）
  function buildCore7(lastLoto6, lastMini){
    const pool = Array.from(new Set([...lastLoto6, ...lastMini]));
    // スコア付け
    const ranked = pool
      .map(n=>({n, s: scoreNumber(n, lastLoto6, lastMini)}))
      .sort((a,b)=> b.s - a.s || a.n - b.n);

    // 固定（自動）：上位から最大2（同点なら小さい方）
    const fixed = ranked.slice(0,2).map(x=>x.n);

    // 母集団7を作る
    const core = [];
    fixed.forEach(n=>core.push(n));

    for(const x of ranked){
      if(core.length>=7) break;
      if(!core.includes(x.n)) core.push(x.n);
    }

    // 足りなければ、固定の近傍±1を候補にして埋める（範囲内）
    function addIfValid(v){
      if(v<1 || v>43) return;
      if(!core.includes(v)) core.push(v);
    }
    let k = 1;
    while(core.length < 7){
      for(const f of fixed.length?fixed:lastLoto6){
        addIfValid(f-k);
        if(core.length>=7) break;
        addIfValid(f+k);
        if(core.length>=7) break;
      }
      k++;
      if(k>10) break; // 安全弁
    }

    core.sort((a,b)=>a-b);
    return { core, fixed, ranked };
  }

  // --- 7C6生成 ---
  function comb7c6(arr7){
    const res = [];
    for(let i=0;i<arr7.length;i++){
      const combo = arr7.filter((_,idx)=>idx!==i);
      res.push(combo);
    }
    return res;
  }

  // --- 描画 ---
  function render(core, combos){
    $("coreOut").textContent = core.length ? core.join(" / ") : "—";
    const out = $("combos");
    out.innerHTML = "";
    combos.forEach((c, idx)=>{
      const div = document.createElement("div");
      div.className = "item mono";
      div.innerHTML = `<strong>候補${idx+1}</strong><span>${c.join(" ")}</span>`;
      out.appendChild(div);
    });
  }

  // --- ボタン ---
  $("btnCalc").addEventListener("click", ()=>{
    setStatus("処理中…");
    setJudge("warn","判定：処理中");

    const loto = readNumsFromBoxes("gridLoto6", 1, 43, 6);
    if(!loto.ok){
      setStatus("準備OK → 入力して計算");
      setJudge("bad","判定：入力不足/エラー");
      return;
    }
    const mini = readNumsFromBoxes("gridMini", 1, 31, null); // 任意
    if(!mini.ok){
      setStatus("準備OK → 入力して計算");
      setJudge("bad","判定：エラー（ミニロト範囲/重複）");
      return;
    }

    const lastLoto6 = loto.nums.slice().sort((a,b)=>a-b);
    const lastMini  = mini.nums.slice().sort((a,b)=>a-b);

    const { core } = buildCore7(lastLoto6, lastMini);
    const combos = comb7c6(core);

    render(core, combos);

    setStatus("計算完了 → この7で勝負");
    setJudge("good","判定：OK");
  });

  $("btnReset").addEventListener("click", ()=>{
    $("gridLoto6").querySelectorAll("input").forEach(i=>{ i.value=""; i.classList.remove("invalid"); });
    $("gridMini").querySelectorAll("input").forEach(i=>{ i.value=""; i.classList.remove("invalid"); });
    $("coreOut").textContent = "—";
    $("combos").innerHTML = "";
    setStatus("準備OK → 入力して計算");
    setJudge("warn","判定：未計算");
  });

  // Service Worker
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
</script>
</body>
</html>
