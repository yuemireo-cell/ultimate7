<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>最強777</title>

  <!-- PWA（すでにあるならOK） -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="./icon-192.png" />

  <style>
    :root{
      --bg:#0b1220;
      --card:rgba(18,26,44,.92);
      --line:rgba(34,48,79,.7);
      --text:#e7eefc;
      --muted:#93a4c7;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:rgba(15,23,42,.55);
      --chip2:rgba(34,48,79,.45);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:linear-gradient(180deg,#071021, #0b1220 35%, #0b1220);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
    }
    header{
      padding:18px 16px 10px;
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(7,16,33,.92), rgba(11,18,32,.65));
      border-bottom:1px solid var(--line);
      z-index:10;
    }
    h1{ margin:0 0 6px; font-size:18px; letter-spacing:.04em; }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .wrap{ padding:0 16px 18px; max-width:860px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid rgba(34,48,79,.9);
      border-radius:16px;
      padding:14px;
      margin:12px 0;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px; font-size:14px; color:#dbe6ff; letter-spacing:.03em; }
    .grid{
      display:grid;
      gap:10px;
    }
    .row2{ grid-template-columns:1fr 1fr; }
    @media (max-width:640px){ .row2{ grid-template-columns:1fr; } }
    .label{
      display:flex; justify-content:space-between; align-items:flex-end;
      margin:6px 2px 6px;
      color:var(--muted);
      font-size:12px;
    }
    .hint{ color:var(--muted); font-size:12px; margin:6px 2px 0; line-height:1.35; }
    .boxrow{ display:flex; gap:8px; flex-wrap:wrap; }
    .nbox{
      width:46px; height:46px;
      border-radius:12px;
      border:1px solid rgba(34,48,79,.9);
      background:rgba(15,23,42,.55);
      color:var(--text);
      font-size:16px;
      text-align:center;
      outline:none;
    }
    .nbox:focus{ border-color:rgba(99,102,241,.9); box-shadow:0 0 0 3px rgba(99,102,241,.18); }
    .btnrow{ display:flex; gap:10px; margin-top:10px; }
    button{
      flex:1;
      border:1px solid rgba(34,48,79,.9);
      background:linear-gradient(180deg, rgba(99,102,241,.26), rgba(34,48,79,.22));
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      font-weight:700;
      letter-spacing:.02em;
    }
    button.secondary{
      background:linear-gradient(180deg, rgba(34,48,79,.25), rgba(15,23,42,.28));
      color:var(--muted);
      font-weight:600;
    }
    .statusbar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(15,23,42,.52);
      border:1px solid rgba(34,48,79,.7);
      color:var(--muted);
      font-size:12px;
      min-width:180px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--warn); }
    .dot.good{ background:var(--good); }
    .dot.bad{ background:var(--bad); }
    .sep{ height:1px; background:var(--line); margin:12px 0; }
    .mono{ font-variant-numeric:tabular-nums; font-feature-settings:"tnum"; }
    .bigline{
      font-size:22px;
      letter-spacing:.08em;
      text-align:center;
      padding:14px 10px;
      border-radius:16px;
      background:rgba(7,16,33,.55);
      border:1px solid rgba(34,48,79,.9);
    }
    .mini{
      font-size:12px; color:var(--muted);
      text-align:center; margin-top:6px;
    }
    .outlist{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .ticket{
      border-radius:18px;
      padding:12px 12px;
      border:1px solid rgba(34,48,79,.85);
      background:rgba(7,16,33,.42);
    }
    .ticket .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    .stars{
      display:flex; gap:4px; align-items:center;
      min-width:74px;
      justify-content:flex-start;
    }
    .star{
      width:16px; height:16px; display:inline-block;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,.25));
      opacity:.92;
    }
    .star svg{ width:16px; height:16px; }
    .tags{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid rgba(34,48,79,.75);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .chip.good{ color:#b8ffd2; border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.12); }
    .chip.warn{ color:#ffe2ad; border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.12); }
    .chip.bad{ color:#ffb6b6; border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.12); }
    .chip.strong{ color:#c7ffdc; border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.15); }
    .chip.bold{ color:#dbe6ff; background:var(--chip2); }
    .numline{
      text-align:center;
      font-size:20px;
      letter-spacing:.10em;
      font-weight:800;
      padding:8px 0 4px;
    }
    details{ margin-top:8px; }
    summary{ color:var(--muted); cursor:pointer; user-select:none; }
    textarea{
      width:100%;
      min-height:92px;
      border-radius:14px;
      border:1px solid rgba(34,48,79,.9);
      background:rgba(15,23,42,.52);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:12px;
      line-height:1.35;
    }
    footer{ padding:10px 16px 18px; color:var(--muted); font-size:11px; text-align:center; }
  </style>
</head>

<body>
  <header>
    <div class="wrap" style="padding:0 16px;">
      <h1>最強777</h1>
      <div class="sub">入力最小 → 引っ張り固定（一致は必ず1個） → 連番あり → ロト6(7C6)＆ミニロト(6C5)を即出力</div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h2>入力（マスで入れるだけ） <span class="sub" style="float:right;">※フィルター/スコアは常時ON（操作不要）</span></h2>

      <div class="grid row2">
        <div>
          <div class="label"><span>ロト6（前回・本数字6個）</span><span class="mono">1〜43</span></div>
          <div class="boxrow" id="loto6Boxes"></div>
          <div class="hint">※引っ張り（前回一致）は「必ず1個だけ」自動固定（他の前回数字は排除）</div>
        </div>

        <div>
          <div class="label"><span>ミニロト（前回・本数字5個）</span><span class="mono">1〜31</span></div>
          <div class="boxrow" id="miniBoxes"></div>
          <div class="hint">※ミニも一致は必ず1個だけ自動固定（連番は入れる）</div>
        </div>
      </div>

      <details>
        <summary>（任意）過去履歴を貼ると「引っ張り選び」がさらに現実寄り</summary>
        <div class="grid row2" style="margin-top:8px;">
          <div>
            <div class="label"><span>ロト6 過去（任意）</span><span class="mono">例：03 10 12 20 31 11</span></div>
            <textarea id="histLoto6" placeholder="例）複数行で貼ってOK
03 10 12 20 31 11
01 05 12 24 31 21
..."></textarea>
          </div>
          <div>
            <div class="label"><span>ミニロト 過去（任意）</span><span class="mono">例：01 09 17 23 29</span></div>
            <textarea id="histMini" placeholder="例）複数行で貼ってOK
01 09 17 23 29
02 05 16 18 31
..."></textarea>
          </div>
        </div>
      </details>

      <div class="btnrow">
        <button id="btnCalc">計算する</button>
        <button class="secondary" id="btnClear">クリア</button>
      </div>

      <div class="statusbar">
        <div class="pill"><span class="dot" id="dotProc"></span><span id="stProc">準備OK → 入力して計算</span></div>
        <div class="pill"><span class="dot" id="dotJudge"></span><span id="stJudge">判定：未計算</span></div>
      </div>
    </div>

    <div class="card">
      <h2>結果（ロト6） <span class="sub" style="float:right;">計算完了 → この7で勝負</span></h2>
      <div class="bigline mono" id="outLoto6Pool">—</div>
      <div class="mini" id="outLoto6Meta">固定（自動・強め）：— ／ 削除は自動判定（入力不要）</div>

      <div class="sep"></div>

      <div class="label"><span>予想（7通り / 7C6）</span><span class="mono" id="outLoto6Count">—</span></div>
      <div class="outlist" id="outLoto6List"></div>
    </div>

    <div class="card">
      <h2>結果（ミニロト） <span class="sub" style="float:right;">計算完了 → この6から勝負</span></h2>
      <div class="bigline mono" id="outMiniPool">—</div>
      <div class="mini" id="outMiniMeta">固定（自動・強め）：— ／ 削除は自動判定（入力不要）</div>

      <div class="sep"></div>

      <div class="label"><span>予想（6通り / 6C5）</span><span class="mono" id="outMiniCount">—</span></div>
      <div class="outlist" id="outMiniList"></div>
    </div>
  </main>

  <footer>最強777 / 一致は必ず1個（引っ張り固定） / 連番は入れる</footer>

<script>
/* ===== 小物 ===== */
const $ = (id)=>document.getElementById(id);
const pad2 = (n)=>String(n).padStart(2,"0");

function setProc(text, type="warn"){
  $("stProc").textContent = text;
  $("dotProc").className = "dot" + (type==="good"?" good":type==="bad"?" bad":"");
}
function setJudge(text, type="warn"){
  $("stJudge").textContent = text;
  $("dotJudge").className = "dot" + (type==="good"?" good":type==="bad"?" bad":"");
}

function makeBoxes(containerId, count){
  const el = $(containerId);
  el.innerHTML = "";
  for(let i=0;i<count;i++){
    const inp = document.createElement("input");
    inp.className="nbox mono";
    inp.inputMode="numeric";
    inp.placeholder="--";
    inp.maxLength=2;
    inp.addEventListener("input", ()=>{
      inp.value = inp.value.replace(/[^\d]/g,"").slice(0,2);
      // 次へ自動移動
      if(inp.value.length>=2){
        const next = el.querySelectorAll("input")[i+1];
        if(next) next.focus();
      }
    });
    el.appendChild(inp);
  }
}

function readBoxes(containerId, count, min, max){
  const arr = [...$(containerId).querySelectorAll("input")].slice(0,count).map(x=>x.value.trim()).filter(Boolean);
  if(arr.length!==count) return {ok:false, reason:`${count}個すべて入力してね`};
  const nums = arr.map(s=>Number(s));
  if(nums.some(n=>!Number.isInteger(n) || n<min || n>max)) return {ok:false, reason:`範囲外（${min}〜${max}）がある`};
  const set = new Set(nums);
  if(set.size!==nums.length) return {ok:false, reason:`重複がある`};
  nums.sort((a,b)=>a-b);
  return {ok:true, nums};
}

function parseHistory(text, min, max, perLine){
  const lines = (text||"").split(/\n/).map(l=>l.trim()).filter(Boolean);
  const draws = [];
  for(const line of lines){
    const nums = line.split(/[^\d]+/).filter(Boolean).map(Number).filter(n=>n>=min && n<=max);
    if(nums.length>=perLine){
      const take = nums.slice(0,perLine);
      const set = new Set(take);
      if(set.size===perLine){
        draws.push(take.sort((a,b)=>a-b));
      }
    }
  }
  return draws;
}

/* ===== スコア ===== */
function freqMap(draws){
  const m = new Map();
  for(const d of draws){
    for(const n of d){
      m.set(n,(m.get(n)||0)+1);
    }
  }
  return m;
}
function gapMap(draws){
  // 0行目が最新として、最後に出た行番号を gap とみなす
  const lastSeen = new Map();
  for(let i=0;i<draws.length;i++){
    for(const n of draws[i]){
      if(!lastSeen.has(n)) lastSeen.set(n,i);
    }
  }
  return lastSeen; // iが小さいほど最近
}
function norm(v, vmin, vmax){
  if(vmax===vmin) return 0;
  return (v - vmin) / (vmax - vmin);
}
function hasConsecutive(nums){
  for(let i=0;i<nums.length-1;i++){
    if(nums[i+1]-nums[i]===1) return true;
  }
  return false;
}

/* ===== 引っ張り1個（自動選定） ===== */
function pickPullNumber(lastNums, game, miniLastNums, histDraws){
  // game: "loto6" or "mini"
  const centerLow = (game==="loto6") ? 12 : 10;
  const centerHigh= (game==="loto6") ? 31 : 22;

  const draws = histDraws || [];
  const fm = freqMap(draws);
  const gm = gapMap(draws);

  // freq/gap のレンジ
  let fmin=Infinity,fmax=-Infinity,gmin=Infinity,gmax=-Infinity;
  if(draws.length){
    for(const n of lastNums){
      const f = fm.get(n)||0;
      const g = gm.has(n)? gm.get(n): draws.length; // 未出は最大
      fmin=Math.min(fmin,f); fmax=Math.max(fmax,f);
      gmin=Math.min(gmin,g); gmax=Math.max(gmax,g);
    }
  }

  let best = null;
  let bestScore = -1e9;

  for(const n of lastNums){
    let s = 0;

    // 中央寄り（強め）
    if(n>=centerLow && n<=centerHigh) s += 3;
    else s += 1;

    // ミニ連動（ロト6のとき）
    if(game==="loto6" && Array.isArray(miniLastNums) && miniLastNums.length){
      if(miniLastNums.includes(n)) s += 2.5; // 共通
      // 近傍（±1）
      if(miniLastNums.some(m=>Math.abs(m-n)===1)) s += 1.0;
    }

    // 履歴があれば：GAP（最近出てないほど加点）＋ 頻出すぎ軽減
    if(draws.length){
      const f = fm.get(n)||0;
      const g = gm.has(n)? gm.get(n): draws.length;
      // gapは「大きいほど」加点、freqは「多すぎ」を少し減点
      s += 2.0 * norm(g, gmin, gmax);
      s += 1.2 * (1 - norm(f, fmin, fmax)); // 多すぎを抑える
    }

    // 端っこは少し抑える（強め）
    if(game==="loto6"){
      if(n<=5 || n>=39) s -= 0.8;
    }else{
      if(n<=3 || n>=29) s -= 0.6;
    }

    if(s>bestScore){
      bestScore=s;
      best=n;
    }
  }
  return best;
}

/* ===== 母集団（ロト6は7 / ミニは6） ===== */
function buildPool(game, pullNumber, lastNums, miniLastNums, histDraws){
  const min = (game==="loto6") ? 1 : 1;
  const max = (game==="loto6") ? 43 : 31;
  const targetSize = (game==="loto6") ? 7 : 6;

  // 前回数字は「引っ張り以外」すべて排除（一致を1に固定するため）
  const banned = new Set(lastNums.filter(n=>n!==pullNumber));

  // 生成候補（最小入力＋賢く）
  const cand = new Set();
  cand.add(pullNumber);

  // 中央アンカー
  const anchors = (game==="loto6") ? [18,20,21,22,24,25,27,28,29,30] : [12,13,14,15,16,17,18,19,20,21];
  for(const a of anchors) cand.add(a);

  // pullの近傍（連番を作りやすく）
  for(const d of [-2,-1,1,2]){
    const x = pullNumber + d;
    if(x>=min && x<=max) cand.add(x);
  }

  // ミニ連動（ロト6側）
  if(game==="loto6" && Array.isArray(miniLastNums) && miniLastNums.length){
    for(const m of miniLastNums){
      cand.add(m);
      if(m-1>=1) cand.add(m-1);
      if(m+1<=43) cand.add(m+1);
    }
  }

  // 履歴があるなら「GAPが大きい」数字も候補へ
  const draws = histDraws || [];
  if(draws.length){
    const gm = gapMap(draws);
    // 未出/久しぶり順に上位を拾う
    const all = [];
    for(let n=min;n<=max;n++){
      if(banned.has(n)) continue;
      const g = gm.has(n)? gm.get(n): draws.length;
      all.push({n,g});
    }
    all.sort((a,b)=>b.g-a.g);
    for(const x of all.slice(0, 10)) cand.add(x.n);
  }

  // スコア付けして上位を選ぶ
  const scored = [];
  for(const n of cand){
    if(n<min || n>max) continue;
    if(banned.has(n)) continue;
    let s = 0;

    // pullは最優先で残す
    if(n===pullNumber) s += 10;

    // 中央寄り加点
    if(game==="loto6"){
      if(n>=12 && n<=31) s+=3; else s+=1;
    }else{
      if(n>=10 && n<=22) s+=3; else s+=1;
    }

    // 連番を作りやすい（近傍が候補にある）加点
    if(cand.has(n-1) || cand.has(n+1)) s+=1.2;

    // ミニ連動（ロト6）
    if(game==="loto6" && miniLastNums && miniLastNums.length){
      if(miniLastNums.includes(n)) s+=2.0;
      if(miniLastNums.some(m=>Math.abs(m-n)===1)) s+=0.8;
    }

    scored.push({n,s});
  }
  scored.sort((a,b)=>b.s-a.s);

  const pool = [];
  for(const it of scored){
    if(pool.length>=targetSize) break;
    if(!pool.includes(it.n)) pool.push(it.n);
  }

  // 最終保証：サイズ不足なら中央から埋める
  let add = 1;
  while(pool.length<targetSize && add<=max){
    const n = (game==="loto6") ? (18+add) : (12+add);
    if(n>=min && n<=max && !banned.has(n) && !pool.includes(n)) pool.push(n);
    add++;
  }

  pool.sort((a,b)=>a-b);
  return pool;
}

/* ===== 7C6 / 6C5 ===== */
function combinations(arr, k){
  const res = [];
  const a = arr.slice();
  function rec(start, comb){
    if(comb.length===k){ res.push(comb.slice()); return; }
    for(let i=start;i<a.length;i++){
      comb.push(a[i]);
      rec(i+1, comb);
      comb.pop();
    }
  }
  rec(0, []);
  return res;
}

/* ===== 口の評価（ランク・★・Score） ===== */
function evalTicket(nums, lastNums, pullNumber, game){
  const sorted = nums.slice().sort((a,b)=>a-b);

  // 絶対条件
  const matchCount = sorted.filter(n=>lastNums.includes(n)).length;
  const pullCount  = sorted.filter(n=>n===pullNumber).length;
  const consecutive = hasConsecutive(sorted);

  // Score
  let score = 0;

  // 一致は必ず1（引っ張りのみ）
  if(pullCount===1 && matchCount===1) score += 10;
  else score -= 999;

  // 連番は入れる（最低1組）
  if(consecutive) score += 6;
  else score -= 999;

  // 中央寄り（強め）
  const centerLow = (game==="loto6") ? 12 : 10;
  const centerHigh= (game==="loto6") ? 31 : 22;
  const centerCnt = sorted.filter(n=>n>=centerLow && n<=centerHigh).length;
  score += centerCnt * 1.1;

  // 端っこ抑制
  if(game==="loto6"){
    const edge = sorted.filter(n=>n<=5 || n>=39).length;
    score -= edge * 0.8;
  }else{
    const edge = sorted.filter(n<=3 || n>=29).length;
    score -= edge * 0.6;
  }

  // 連番の“質”（2連が複数/3連など）
  let streak2=0, streak3=0;
  for(let i=0;i<sorted.length-1;i++){
    if(sorted[i+1]-sorted[i]===1) streak2++;
    if(i<sorted.length-2 && sorted[i+2]-sorted[i]===2 && sorted[i+1]-sorted[i]===1) streak3++;
  }
  score += streak2 * 0.7 + streak3 * 0.9;

  // ランク
  let label="標準", tag="warn", stars=2;
  if(score>=18){ label="強い"; tag="strong"; stars=3; }
  else if(score>=15){ label="強気"; tag="strong"; stars=2; }
  else if(score>=13){ label="堅い"; tag="warn"; stars=1; }
  else { label="様子見"; tag="bad"; stars=1; }

  return {
    ok: (pullCount===1 && matchCount===1 && consecutive),
    sorted,
    matchCount,
    streak2,
    score: Math.round(score*10)/10,
    label, tag, stars
  };
}

function starIcons(count){
  const wrap = document.createElement("div");
  wrap.className="stars";
  for(let i=0;i<count;i++){
    const s = document.createElement("span");
    s.className="star";
    s.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 2.6l2.7 6.2 6.7.6-5 4.4 1.5 6.6-5.9-3.4-5.9 3.4 1.5-6.6-5-4.4 6.7-.6L12 2.6z"
          fill="rgba(231,238,252,.92)" />
      </svg>`;
    wrap.appendChild(s);
  }
  return wrap;
}

function renderTickets(container, tickets, lastNums, pullNumber, game){
  container.innerHTML="";
  for(const t of tickets){
    const e = evalTicket(t, lastNums, pullNumber, game);
    if(!e.ok) continue;

    const card = document.createElement("div");
    card.className="ticket";

    const top = document.createElement("div");
    top.className="top";

    const stars = starIcons(e.stars);
    top.appendChild(stars);

    const tags = document.createElement("div");
    tags.className="tags";

    const c1 = document.createElement("span");
    c1.className="chip " + (e.tag==="strong"?"strong":e.tag==="warn"?"warn":"bad");
    c1.textContent = e.label;
    tags.appendChild(c1);

    const c2 = document.createElement("span");
    c2.className="chip bold mono";
    c2.textContent = `一致:${e.matchCount}`;
    tags.appendChild(c2);

    const c3 = document.createElement("span");
    c3.className="chip bold mono";
    c3.textContent = `連番:${e.streak2}`;
    tags.appendChild(c3);

    const c4 = document.createElement("span");
    c4.className="chip bold mono";
    c4.textContent = `Score:${e.score}`;
    tags.appendChild(c4);

    top.appendChild(tags);
    card.appendChild(top);

    const num = document.createElement("div");
    num.className="numline mono";
    num.textContent = e.sorted.map(pad2).join(" ");
    card.appendChild(num);

    container.appendChild(card);
  }
}

/* ===== メイン計算 ===== */
function calc(){
  setProc("処理中…", "warn");
  setJudge("判定：処理中", "warn");

  // 入力
  const loto6 = readBoxes("loto6Boxes", 6, 1, 43);
  const mini  = readBoxes("miniBoxes", 5, 1, 31);

  if(!loto6.ok || !mini.ok){
    setProc("準備OK → 入力して計算", "warn");
    setJudge(`判定：入力不足（${!loto6.ok?loto6.reason:mini.reason}）`, "bad");
    return;
  }

  // 履歴（任意）
  const histL6 = parseHistory($("histLoto6").value, 1, 43, 6);
  const histMi = parseHistory($("histMini").value, 1, 31, 5);

  // 引っ張り（必ず1個だけ）
  const pullL6 = pickPullNumber(loto6.nums, "loto6", mini.nums, histL6);
  const pullMi = pickPullNumber(mini.nums, "mini", null, histMi);

  // 母集団（ロト6:7 / ミニ:6）
  const poolL6 = buildPool("loto6", pullL6, loto6.nums, mini.nums, histL6);
  const poolMi = buildPool("mini",  pullMi,  mini.nums, null, histMi);

  // 口生成
  const ticketsL6 = combinations(poolL6, 6).map(x=>x.sort((a,b)=>a-b));
  const ticketsMi = combinations(poolMi, 5).map(x=>x.sort((a,b)=>a-b));

  // ルール適用＆評価で並べ替え（Score順）
  const evaledL6 = ticketsL6
    .map(t=>({t, e: evalTicket(t, loto6.nums, pullL6, "loto6")}))
    .filter(x=>x.e.ok)
    .sort((a,b)=>b.e.score-a.e.score)
    .map(x=>x.t);

  const evaledMi = ticketsMi
    .map(t=>({t, e: evalTicket(t, mini.nums, pullMi, "mini")}))
    .filter(x=>x.e.ok)
    .sort((a,b)=>b.e.score-a.e.score)
    .map(x=>x.t);

  // 表示
  $("outLoto6Pool").textContent = poolL6.map(pad2).join(" ");
  $("outLoto6Meta").textContent = `固定（自動・強め）：${pad2(pullL6)} ／ 一致は必ず1個（他の前回数字は排除）`;
  $("outLoto6Count").textContent = `表示: ${evaledL6.length} / 7`;

  $("outMiniPool").textContent = poolMi.map(pad2).join(" ");
  $("outMiniMeta").textContent = `固定（自動・強め）：${pad2(pullMi)} ／ 一致は必ず1個（他の前回数字は排除）`;
  $("outMiniCount").textContent = `表示: ${evaledMi.length} / 6`;

  renderTickets($("outLoto6List"), evaledL6, loto6.nums, pullL6, "loto6");
  renderTickets($("outMiniList"), evaledMi, mini.nums, pullMi, "mini");

  // もし全部落ちたら（母集団が偏りすぎ）→メッセージ
  if(evaledL6.length===0 || evaledMi.length===0){
    setProc("完了（ただし母集団が偏って条件を満たせない可能性）", "warn");
    setJudge("判定：エラー（条件を満たす口が作れない）", "bad");
  }else{
    setProc("完了", "good");
    setJudge("判定：OK", "good");
  }
}

function clearAll(){
  [...$("loto6Boxes").querySelectorAll("input"), ...$("miniBoxes").querySelectorAll("input")].forEach(i=>i.value="");
  $("histLoto6").value="";
  $("histMini").value="";
  $("outLoto6Pool").textContent="—";
  $("outMiniPool").textContent="—";
  $("outLoto6Meta").textContent="固定（自動・強め）：— ／ 削除は自動判定（入力不要）";
  $("outMiniMeta").textContent="固定（自動・強め）：— ／ 削除は自動判定（入力不要）";
  $("outLoto6Count").textContent="—";
  $("outMiniCount").textContent="—";
  $("outLoto6List").innerHTML="";
  $("outMiniList").innerHTML="";
  setProc("準備OK → 入力して計算", "warn");
  setJudge("判定：未計算", "warn");
}

/* ===== 起動 ===== */
makeBoxes("loto6Boxes", 6);
makeBoxes("miniBoxes", 5);

$("btnCalc").addEventListener("click", calc);
$("btnClear").addEventListener("click", clearAll);
</script>

</body>
</html>
